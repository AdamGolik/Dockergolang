<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API CRUD App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
<div class="container mx-auto p-4 bg-white shadow rounded">
    <h1 class="text-2xl font-bold mb-4 text-center">Lista użytkowników (CRUD)</h1>

    <!-- Search bar -->
    <div class="mb-6">
        <input
                type="text"
                id="search"
                placeholder="Szukaj użytkownika..."
                class="block w-full p-2 border rounded"
        />
        <small class="text-gray-500">Wyszukiwanie po imieniu, nazwisku, emailu, lub nazwie użytkownika.</small>
    </div>

    <!-- Miejsce na listę użytkowników -->
    <ul id="users-list" class="list-disc pl-5 mb-6 space-y-2">
        <li class="text-gray-500">Ładowanie danych...</li>
    </ul>

    <!-- Formularz dodawania użytkownika -->
    <form id="user-form" class="space-y-4">
        <input type="hidden" id="user-id" /> <!-- Ukryty input dla ID użytkownika podczas edycji -->

        <input
                type="text"
                id="name"
                placeholder="Imię"
                required
                class="block w-full p-2 border rounded"
        />
        <input
                type="text"
                id="last_name"
                placeholder="Nazwisko"
                required
                class="block w-full p-2 border rounded"
        />
        <input
                type="number"
                id="age"
                placeholder="Wiek"
                required
                min="1"
                class="block w-full p-2 border rounded"
        />
        <input
                type="email"
                id="email"
                placeholder="Email"
                required
                class="block w-full p-2 border rounded"
        />
        <input
                type="text"
                id="username"
                placeholder="Nazwa użytkownika (username)"
                required
                class="block w-full p-2 border rounded"
        />
        <input
                type="password"
                id="password"
                placeholder="Hasło"
                required
                class="block w-full p-2 border rounded"
        />
        <input
                type="text"
                id="telephone"
                placeholder="Telefon (np. +48234567890)"
                pattern="^[+][0-9]{10,15}$"
                title="Numer telefonu w formacie np. +48234567890"
                required
                class="block w-full p-2 border rounded"
        />

        <button
                type="submit"
                class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 w-full"
        >
            Zapisz
        </button>
    </form>
</div>

<!-- JavaScript -->
<script>
    const API_URL = 'http://localhost:8080'; // Adres Twojego API

    // Formularz dodawania/edycji użytkownika
    document.getElementById('user-form').addEventListener('submit', async (event) => {
        event.preventDefault(); // Zatrzymanie domyślnego działania formularza (przeładowania strony)

        // Pobranie danych z formularza
        const id = document.getElementById('user-id').value; // ID do edycji, puste dla nowego użytkownika
        const name = document.getElementById('name').value;
        const last_name = document.getElementById('last_name').value;
        const age = document.getElementById('age').value;
        const email = document.getElementById('email').value;
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const telephone = document.getElementById('telephone').value;

        // Obiekt użytkownika
        const userData = {
            name,
            last_name,
            age: parseInt(age),
            email,
            username,
            password,
            telephone,
        };

        try {
            let endpoint = API_URL;
            let method = 'POST';

            // Jeżeli ID istnieje, wykonujemy edycję (PUT)
            if (id) {
                endpoint = `${API_URL}/${id}`;
                method = 'PUT';
            }

            const response = await fetch(endpoint, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData),
            });

            if (!response.ok) {
                throw new Error('Wystąpił błąd podczas przesyłania danych na serwer.');
            }

            const result = await response.json();
            alert(result.message || (id ? 'Użytkownik został zaktualizowany!' : 'Użytkownik został dodany!'));

            // Resetowanie formularza oraz odświeżanie listy użytkowników
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = ''; // Czyścimy pole ID (na wypadek edycji)
            loadUsers(); // Odświeżenie listy użytkowników
        } catch (error) {
            console.error(error);
            alert('Nie udało się zapisać danych użytkownika.');
        }
    });

    // Funkcja edycji użytkownika (wypełnia formularz danymi użytkownika)
    async function editUser(id) {
        try {
            const response = await fetch(`${API_URL}/${id}`);
            if (!response.ok) {
                throw new Error('Nie udało się pobrać danych użytkownika.');
            }

            const user = await response.json();

            // Wypełnienie formularza danymi użytkownika
            document.getElementById('user-id').value = user.id;
            document.getElementById('name').value = user.name;
            document.getElementById('last_name').value = user.last_name;
            document.getElementById('age').value = user.age;
            document.getElementById('email').value = user.email;
            document.getElementById('username').value = user.username;
            document.getElementById('password').value = ''; // Hasło pozostaje puste (należy je wprowadzić ponownie)
            document.getElementById('telephone').value = user.telephone;
        } catch (error) {
            console.error(error);
            alert('Nie udało się wczytać danych użytkownika.');
        }
    }

    // Ładowanie listy użytkowników
    async function loadUsers(search = '') {
        try {
            const endpoint = search ? `${API_URL}/search?search=${encodeURIComponent(search)}` : API_URL;
            const response = await fetch(endpoint);

            if (!response.ok) {
                throw new Error('Wystąpił błąd podczas ładowania użytkowników.');
            }

            const { users } = await response.json();
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';

            if (users.length === 0) {
                usersList.innerHTML = '<li class="text-gray-500">Brak użytkowników do wyświetlenia.</li>';
                return;
            }

            // Użytkownicy są wyświetlani na liście
            users.forEach(user => {
                const listItem = document.createElement('li');
                listItem.classList.add('flex', 'justify-between', 'items-center', 'border-b', 'py-2');
                listItem.innerHTML = `
                    <span>
                        <strong>Imię:</strong> ${user.name},
                        <strong>Nazwisko:</strong> ${user.last_name},
                        <strong>Wiek:</strong> ${user.age},
                        <strong>Email:</strong> ${user.email},
                        <strong>Username:</strong> ${user.username},
                        <strong>Telefon:</strong> ${user.telephone}
                    </span>
                    <div class="flex gap-2">
                        <button onclick="editUser(${user.id})" class="text-blue-500">Edytuj</button>
                        <button onclick="deleteUser(${user.id})" class="text-red-500">Usuń</button>
                    </div>
                `;
                usersList.appendChild(listItem);
            });
        } catch (error) {
            console.error(error);
            alert('Nie udało się załadować użytkowników.');
        }
    }

    // Funkcja usuwania użytkownika (opcjonalnie)
    async function deleteUser(id) {
        if (!confirm('Czy na pewno chcesz usunąć tego użytkownika?')) return;

        try {
            const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            if (!response.ok) {
                throw new Error('Nie udało się usunąć użytkownika.');
            }

            alert('Użytkownik został usunięty.');
            loadUsers(); // Odświeżenie listy użytkowników
        } catch (error) {
            console.error(error);
            alert('Wystąpił błąd podczas usuwania użytkownika.');
        }
    }

    // Obsługa pola wyszukiwania
    document.getElementById('search').addEventListener('input', (e) => {
        const searchQuery = e.target.value.trim(); // Pobranie wartości wpisanej w polu wyszukiwania
        loadUsers(searchQuery); // Wywołanie wyszukiwania
    });

    // Załaduj użytkowników po załadowaniu strony
    document.addEventListener('DOMContentLoaded', () => loadUsers());
</script>
</body>
</html>